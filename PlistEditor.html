<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Plist Editor - Cosmic Red (Ultimate Fix)</title>
<style>
  html, body {
    margin: 0; padding: 0;
    height: 100%;
    background: #100000;
    font-family: monospace;
    color: #fff;
  }
  .container {
    width: 90%; max-width: 900px;
    margin: 20px auto;
    background: #200000;
    border: 1px solid #ff3355;
    border-radius: 8px;
    padding: 15px;
  }
  h2 { text-align: center; color: #ff3355; margin-top: 0; }
  input[type=file], button {
    margin: 5px 5px 10px 0;
    padding: 4px 8px;
    background: #300;
    border: 1px solid #ff3355;
    color: #ff3355;
    cursor: pointer;
    border-radius: 4px;
  }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  #tree {
    max-height: 500px;
    overflow-y: auto;
    background: #150000;
    border: 1px solid #ff3355;
    border-radius: 4px;
    padding: 5px;
  }
  .line { display: flex; align-items: center; margin: 2px 0; }
  input.key, input.value {
    background: transparent;
    border: 1px dashed #ff5577;
    color: #fff;
    padding: 2px 4px;
    margin-right: 4px;
    width: 200px;
  }
  .type { color: #aaa; width: 60px; }
  .copy-btn {
    background: #300;
    border: 1px solid #ff5577;
    color: #ff5577;
    padding: 2px 6px;
    cursor: pointer;
    font-size: 12px;
    margin-left: 4px;
  }
</style>
</head>
<body>
<div class="container">
  <h2>üöÄ Plist Editor - HeiusDev Maker</h2>
  <input type="file" id="fileInput" accept=".plist,.xml,.mobileconfig">
  <button id="downloadBtn" disabled>T·∫£i v·ªÅ (.plist)</button>
  <div id="tree"></div>
</div>

<script>
let xmlDoc;
let rawText = ""; // gi·ªØ text g·ªëc ƒë·ªÅ ph√≤ng DOMParser l·ªói
const fileInput = document.getElementById("fileInput");
const treeDiv = document.getElementById("tree");
const downloadBtn = document.getElementById("downloadBtn");

fileInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    // B·ªè BOM ·∫©n n·∫øu c√≥
    rawText = evt.target.result.replace(/^\uFEFF/, "").trim();

    // DOMParser c√≥ th·ªÉ l·ªói, n√™n b·ªçc try-catch
    let parser = new DOMParser();
    xmlDoc = parser.parseFromString(rawText, "application/xml");

    const parseError = xmlDoc.getElementsByTagName("parsererror");
    if (parseError.length > 0) {
      // N·∫øu l·ªói parse, th·ª≠ l·∫°i b·∫±ng c√°ch l√†m s·∫°ch chu·ªói XML
      rawText = rawText
        .replace(/&(?!amp;|lt;|gt;|quot;|apos;)/g, "&amp;")
        .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g, ""); // lo·∫°i k√Ω t·ª± control
      xmlDoc = parser.parseFromString(rawText, "application/xml");
    }

    if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
      alert("‚ùå File plist kh√¥ng h·ª£p l·ªá ho·∫∑c l·ªói c√∫ ph√°p (k·ªÉ c·∫£ sau khi x·ª≠ l√Ω).");
      return;
    }

    treeDiv.innerHTML = "";
    renderTree(xmlDoc.documentElement, treeDiv);
    downloadBtn.disabled = false;
  };
  reader.readAsText(file);
});

function renderTree(node, container) {
  for (let i = 0; i < node.children.length; i++) {
    const child = node.children[i];
    if (child.tagName === "key") {
      const keyNode = child;
      const valueNode = child.nextElementSibling;
      const line = document.createElement("div");
      line.className = "line";

      const keyInput = document.createElement("input");
      keyInput.className = "key";
      keyInput.value = keyNode.textContent;
      keyInput.addEventListener("input", () => {
        keyNode.textContent = keyInput.value;
      });
      line.appendChild(keyInput);

      const copyKeyBtn = document.createElement("button");
      copyKeyBtn.className = "copy-btn";
      copyKeyBtn.textContent = "üìã";
      copyKeyBtn.title = "Copy key";
      copyKeyBtn.onclick = () => navigator.clipboard.writeText(keyInput.value);
      line.appendChild(copyKeyBtn);

      if (valueNode) {
        const typeSpan = document.createElement("span");
        typeSpan.className = "type";
        typeSpan.textContent = "(" + valueNode.tagName + ")";
        line.appendChild(typeSpan);

        const valInput = document.createElement("input");
        valInput.className = "value";
        valInput.value = valueNode.textContent;
        valInput.addEventListener("input", () => {
          while (valueNode.firstChild) valueNode.removeChild(valueNode.firstChild);
          valueNode.appendChild(document.createTextNode(valInput.value));
        });
        line.appendChild(valInput);

        const copyValBtn = document.createElement("button");
        copyValBtn.textContent = "üìã";
        copyValBtn.className = "copy-btn";
        copyValBtn.title = "Copy value";
        copyValBtn.onclick = () => navigator.clipboard.writeText(valInput.value);
        line.appendChild(copyValBtn);
      }
      container.appendChild(line);
    } else if (child.tagName === "dict" || child.tagName === "array") {
      renderTree(child, container);
    }
  }
}

downloadBtn.addEventListener("click", () => {
  const serializer = new XMLSerializer();
  const plistOnly = xmlDoc.documentElement;

  let xmlStr = serializer.serializeToString(plistOnly);

  // Th√™m header chu·∫©n
  const header =
    '<?xml version="1.0" encoding="UTF-8"?>\n' +
    '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" ' +
    '"http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n';
  xmlStr = header + xmlStr;

  const blob = new Blob([xmlStr], { type: "application/xml" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "edited.plist";
  a.click();
  URL.revokeObjectURL(a.href);
});

// Th√™m ph√≠m t·∫Øt Ctrl+S
document.addEventListener("keydown", e => {
  if ((e.ctrlKey || e.metaKey) && e.key === "s") {
    e.preventDefault();
    if (!downloadBtn.disabled) downloadBtn.click();
  }
});
</script>
</body>
</html>
