<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>MobileConfig Maker — Simple + Bloat + Zip</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Inter,Segoe UI,Roboto,Arial;margin:18px;max-width:980px}
    h1{font-size:20px;margin-bottom:6px}
    label{display:block;margin-top:10px;font-weight:600}
    input[type=text], input[type=number], textarea, select {
      width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin-top:6px;
      box-sizing:border-box;font-size:14px;
    }
    .row{display:flex;gap:10px}
    .col{flex:1}
    button{margin-top:12px;padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:white;font-weight:600;cursor:pointer}
    .muted{color:#666;font-size:13px}
    .danger{color:#a00}
    pre{background:#f9f9fb;border:1px dashed #eee;padding:10px;border-radius:6px;overflow:auto}
    .small{font-size:13px;color:#444}
    .payload{border:1px solid #eee;padding:10px;border-radius:8px;margin-top:10px}
    footer{margin-top:18px;color:#666;font-size:13px}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn-secondary{background:#10b981}
    .btn-zip{background:#ef4444}
    .tiny{font-size:12px;padding:6px 8px}
  </style>
  <!-- JSZip CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-1q+8c6qU4r5+z2H2Sgq2K9rGQn+g8y2zZp3cO7q2u2K0qvX0m4s7GmE2f9WJrVxk5mJk5U1Uq6k5vLJq5v2Yg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <h1>MobileConfig Maker — đơn giản + "inflate" (giả lập cấu hình nặng)</h1>
  <div class="small muted">Tạo nhanh file .mobileconfig. Chức năng "Bloat" chèn dữ liệu base64 lớn vào payload để tăng kích thước file (ví dụ test cài đặt, truyền tải, đo hiệu năng...).</div>

  <label>Payload Display Name
    <input id="displayName" type="text" value="Example Configuration">
  </label>

  <div class="row">
    <div class="col">
      <label>Identifier (bundle id)
        <input id="identifier" type="text" value="com.example.mobileconfig">
      </label>
    </div>
    <div class="col">
      <label>Organization
        <input id="organization" type="text" value="My Org">
      </label>
    </div>
  </div>

  <label>Number of payloads
    <select id="payloadCount">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="5">5</option>
    </select>
  </label>

  <div id="payloadsContainer"></div>

  <label>Inflate / Bloat settings</label>
  <div class="row">
    <div class="col">
      <label>Số MB muốn thêm (approx)</label>
      <input id="bloatMB" type="number" min="0" max="500" step="1" value="0">
      <div class="muted">Nhập 0 để không bloat. Giới hạn khuyến nghị: ≤50 MB.</div>
    </div>
    <div class="col">
      <label>Chèn vào payload số (1...)</label>
      <input id="bloatPayloadIndex" type="number" min="1" value="1">
      <div class="muted">Chọn payload để chèn dữ liệu giả.</div>
    </div>
  </div>

  <div style="margin-top:10px">
    <label>
      <input id="useRandom" type="checkbox" /> Sử dụng dữ liệu "random" (thực tế là ký tự lặp nhưng khác nhau ở một block) — làm base64 ít nén tốt hơn
    </label>
  </div>

  <div class="btn-row">
    <button id="downloadBtn" class="tiny">Tải Cấu Hình Về Máy (.mobileconfig)</button>
    <button id="zipBtn" class="tiny btn-zip">Đóng Gói Zip Và Tải Về Tệp (.zip)</button>
  </div>

  <div id="status" style="margin-top:10px"></div>

  <h3 style="margin-top:20px">Preview (snippet)</h3>
  <pre id="preview" aria-live="polite"></pre>

  <footer>
    <div class="danger">Cảnh báo:</div>
    <div class="small">File được tạo bởi trình duyệt. Không upload nội dung nhạy cảm vào đây. Nếu chọn bloat lớn, trình duyệt có thể sử dụng nhiều RAM và bị chậm hoặc crash.</div>
  </footer>

<script>
/* Utilities */
function escapeXml(unsafe) {
  return unsafe.replace(/[<>&'"]/g, function (c) {
    switch (c) {
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '&': return '&amp;';
      case '\'': return '&apos;';
      case '"': return '&quot;';
    }
  });
}

// chunked btoa for large strings (safe for repeated ASCII 'A' etc.)
function base64ChunkedFromAsciiString(str) {
  const chunk = 0x8000; // 32k
  let index = 0;
  let result = '';
  while (index < str.length) {
    result += btoa(str.slice(index, Math.min(index + chunk, str.length)));
    index += chunk;
  }
  return result;
}

function generateDummyBase64(bytes, useRandom) {
  const block = useRandom ? 'ABCD' : 'A';
  const repeats = Math.ceil(bytes / block.length);
  let s = '';
  const chunkRepeat = 10000;
  let remainingRepeats = repeats;
  while (remainingRepeats > 0) {
    const r = Math.min(remainingRepeats, chunkRepeat);
    s += block.repeat(r);
    remainingRepeats -= r;
  }
  if (s.length > bytes) s = s.slice(0, bytes);
  return base64ChunkedFromAsciiString(s);
}

function makeUUID() {
  if (crypto && crypto.randomUUID) return crypto.randomUUID();
  function s4(){return Math.floor((1+Math.random())*0x10000).toString(16).substring(1);}
  return s4()+s4()+'-'+s4()+'-'+s4()+'-'+s4()+'-'+s4()+s4()+s4();
}

/* UI: dynamic payload controls */
const payloadsContainer = document.getElementById('payloadsContainer');
const payloadCountEl = document.getElementById('payloadCount');

function buildPayloadControls() {
  payloadsContainer.innerHTML = '';
  const count = parseInt(payloadCountEl.value, 10);
  for (let i=1;i<=count;i++){
    const div = document.createElement('div');
    div.className = 'payload';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Payload ${i}</strong>
        <span class="muted">UUID: <span id="p${i}uuid">${makeUUID()}</span></span>
      </div>
      <label>Payload Type
        <input id="p${i}type" type="text" value="com.apple.ManagedClient.preferences">
      </label>
      <label>Payload Display Name
        <input id="p${i}display" type="text" value="Payload ${i}">
      </label>
      <label>Payload Identifier
        <input id="p${i}ident" type="text" value="com.example.payload${i}">
      </label>
      <label>Short description (optional)
        <input id="p${i}desc" type="text" value="Demo payload ${i}">
      </label>
    `;
    payloadsContainer.appendChild(div);
  }
}
buildPayloadControls();
payloadCountEl.addEventListener('change', buildPayloadControls);

/* Generate plist XML string */
function generatePlistXml(options) {
  const { displayName, identifier, organization, payloads, bloatMB, bloatPayloadIndex, useRandom } = options;
  const bloatBytes = Math.max(0, Math.floor((bloatMB||0) * 1024 * 1024));

  let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" ` +
            `"http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n<dict>\n`;

  xml += `\t<key>PayloadDisplayName</key>\n\t<string>${escapeXml(displayName)}</string>\n`;
  xml += `\t<key>PayloadIdentifier</key>\n\t<string>${escapeXml(identifier)}</string>\n`;
  xml += `\t<key>PayloadOrganization</key>\n\t<string>${escapeXml(organization)}</string>\n`;
  xml += `\t<key>PayloadRemovalDisallowed</key>\n\t<false/>\n`;
  xml += `\t<key>PayloadType</key>\n\t<string>Configuration</string>\n`;
  xml += `\t<key>PayloadUUID</key>\n\t<string>${makeUUID()}</string>\n`;
  xml += `\t<key>PayloadVersion</key>\n\t<integer>1</integer>\n`;

  xml += `\t<key>PayloadContent</key>\n\t<array>\n`;

  for (let i=0;i<payloads.length;i++){
    const p = payloads[i];
    xml += `\t\t<dict>\n`;
    xml += `\t\t\t<key>PayloadType</key>\n\t\t\t<string>${escapeXml(p.type)}</string>\n`;
    xml += `\t\t\t<key>PayloadVersion</key>\n\t\t\t<integer>1</integer>\n`;
    xml += `\t\t\t<key>PayloadIdentifier</key>\n\t\t\t<string>${escapeXml(p.ident)}</string>\n`;
    xml += `\t\t\t<key>PayloadUUID</key>\n\t\t\t<string>${p.uuid}</string>\n`;
    xml += `\t\t\t<key>PayloadDisplayName</key>\n\t\t\t<string>${escapeXml(p.display)}</string>\n`;
    xml += `\t\t\t<key>PayloadDescription</key>\n\t\t\t<string>${escapeXml(p.desc || '')}</string>\n`;

    if (bloatBytes > 0 && (i+1) === bloatPayloadIndex) {
      xml += `\t\t\t<key>DummyData</key>\n\t\t\t<data>\n`;
      const chunkSize = 76;
      const base64 = generateDummyBase64(bloatBytes, useRandom);
      for (let j=0;j<base64.length;j+=chunkSize){
        xml += '\t\t\t\t' + base64.slice(j, j+chunkSize) + '\n';
      }
      xml += `\t\t\t</data>\n`;
    }

    xml += `\t\t</dict>\n`;
  }

  xml += `\t</array>\n`;
  xml += `</dict>\n</plist>\n`;
  return xml;
}

/* Download helpers */
function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function collectOptions() {
  const displayName = document.getElementById('displayName').value || 'Config';
  const identifier = document.getElementById('identifier').value || ('com.example.' + Date.now());
  const organization = document.getElementById('organization').value || '';
  const payloadCount = parseInt(document.getElementById('payloadCount').value,10);
  const bloatMB = parseInt(document.getElementById('bloatMB').value || '0',10);
  const bloatPayloadIndex = parseInt(document.getElementById('bloatPayloadIndex').value || '1',10);
  const useRandom = document.getElementById('useRandom').checked;

  const payloads = [];
  for (let i=1;i<=payloadCount;i++){
    const type = document.getElementById(`p${i}type`).value || `com.example.payload${i}`;
    const display = document.getElementById(`p${i}display`).value || `Payload ${i}`;
    const ident = document.getElementById(`p${i}ident`).value || `com.example.payload${i}`;
    const desc = document.getElementById(`p${i}desc`).value || '';
    const uuid = document.getElementById(`p${i}uuid`).textContent || makeUUID();
    payloads.push({type,display,ident,desc,uuid});
  }

  return { displayName, identifier, organization, payloads, bloatMB, bloatPayloadIndex, useRandom };
}

/* Buttons */
const downloadBtn = document.getElementById('downloadBtn');
const zipBtn = document.getElementById('zipBtn');
const status = document.getElementById('status');
const preview = document.getElementById('preview');

function showPreview(xml) {
  preview.textContent = xml.slice(0, 1200) + (xml.length>1200 ? '\n\n... (truncated preview) ...' : '');
}

downloadBtn.addEventListener('click', async () => {
  try {
    status.textContent = '';
    downloadBtn.disabled = true;
    zipBtn.disabled = true;

    const opts = collectOptions();
    if (opts.bloatMB > 200) {
      if (!confirm('Bạn đang yêu cầu >200 MB bloat — điều này có thể khiến trình duyệt rất chậm hoặc crash. Tiếp tục?')) {
        downloadBtn.disabled = false;
        zipBtn.disabled = false;
        return;
      }
    }

    status.textContent = 'Đang tạo .mobileconfig...';
    await new Promise(r => setTimeout(r, 20)); // let UI update

    const xml = generatePlistXml(opts);
    showPreview(xml);

    const blob = new Blob([xml], {type: 'application/x-apple-aspen-config'});
    const fnameBase = (opts.displayName.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9\-_]/g,'') || 'config');
    const fname = fnameBase + '.mobileconfig';
    downloadBlob(blob, fname);

    status.innerHTML = `Hoàn tất — file "${fname}" đã được tạo và tải xuống. <span class="muted">Kích thước: ${Math.round(blob.size/1024)} KB</span>`;
  } catch (err) {
    console.error(err);
    status.textContent = 'Lỗi khi tạo/tải file: ' + (err && err.message ? err.message : err);
  } finally {
    downloadBtn.disabled = false;
    zipBtn.disabled = false;
  }
});

zipBtn.addEventListener('click', async () => {
  try {
    if (typeof JSZip === 'undefined') {
      alert('JSZip chưa được tải. Vui lòng đảm bảo CDN JSZip có thể truy cập.');
      return;
    }
    status.textContent = '';
    downloadBtn.disabled = true;
    zipBtn.disabled = true;

    const opts = collectOptions();
    if (opts.bloatMB > 200) {
      if (!confirm('Bạn đang yêu cầu >200 MB bloat — điều này có thể khiến trình duyệt rất chậm hoặc crash. Tiếp tục?')) {
        downloadBtn.disabled = false;
        zipBtn.disabled = false;
        return;
      }
    }

    status.textContent = 'Đang tạo .mobileconfig và đóng gói zip...';
    await new Promise(r => setTimeout(r, 20));

    const xml = generatePlistXml(opts);
    showPreview(xml);
    const blobCfg = new Blob([xml], {type: 'application/x-apple-aspen-config'});

    const zip = new JSZip();
    const fnameBase = (opts.displayName.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9\-_]/g,'') || 'config');
    const cfgName = fnameBase + '.mobileconfig';
    zip.file(cfgName, blobCfg);

    // add README metadata file
    const readme = `Generated: ${new Date().toISOString()}\nConfig name: ${opts.displayName}\nIdentifier: ${opts.identifier}\nPayloads: ${opts.payloads.length}\nBloat MB: ${opts.bloatMB}\n`;
    zip.file('README.txt', readme);

    status.textContent = 'Đang nén zip (có thể mất vài giây với file lớn)...';

    // generate zip as blob
    const zipBlob = await zip.generateAsync({type:"blob"});
    const zipName = fnameBase + '.zip';
    downloadBlob(zipBlob, zipName);

    status.innerHTML = `Hoàn tất — zip "${zipName}" đã được tạo và tải xuống. <span class="muted">Kích thước zip: ${Math.round(zipBlob.size/1024)} KB</span>`;
  } catch (err) {
    console.error(err);
    status.textContent = 'Lỗi khi đóng gói zip: ' + (err && err.message ? err.message : err);
  } finally {
    downloadBtn.disabled = false;
    zipBtn.disabled = false;
  }
});
</script>
</body>
</html>
