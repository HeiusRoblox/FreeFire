<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Deep XML Decoder - Worker</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{
  background:#0a0000;color:#fff;font-family:monospace;
  margin:0;padding:20px;
}
h2{text-align:center;color:#ff5577;margin-top:0;}
.container{
  max-width:900px;margin:0 auto;background:#1b0000;
  border:1px solid #ff3355;border-radius:8px;padding:16px;
}
input[type=file],button{
  background:#300;border:1px solid #ff3355;color:#ff5577;
  border-radius:4px;padding:6px 10px;margin:5px 3px;cursor:pointer;
}
button:disabled{opacity:0.4;cursor:not-allowed;}
#output{
  background:#140000;border:1px solid #ff3355;
  border-radius:4px;padding:10px;margin-top:10px;
  max-height:500px;overflow:auto;white-space:pre-wrap;
}
.progress{height:6px;background:#400;margin-top:6px;border-radius:3px;overflow:hidden;}
.bar{height:100%;width:0;background:#ff5577;transition:width .2s;}
.note{font-size:13px;color:#ccc;margin-top:8px;}
</style>
</head>
<body>
<div class="container">
<h2>üß© Deep XML Decoder (Web Worker)</h2>
<input type="file" id="fileInput" accept=".plist,.xml,.mobileconfig,.txt">
<button id="decodeBtn" disabled>Gi·∫£i m√£</button>
<button id="downloadBtn" disabled>T·∫£i v·ªÅ (.txt)</button>
<div class="progress"><div class="bar" id="bar"></div></div>
<div id="output">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
<div class="note">Gi·∫£i m√£ c·ª±c s√¢u, ch·∫°y trong lu·ªìng n·ªÅn, kh√¥ng bao gi·ªù ƒë∆°.</div>
</div>

<script>
const f=document.getElementById("fileInput");
const decodeBtn=document.getElementById("decodeBtn");
const downloadBtn=document.getElementById("downloadBtn");
const output=document.getElementById("output");
const bar=document.getElementById("bar");

let raw="",decoded="",filename="decoded";
let worker;

f.onchange=()=>{
  const file=f.files[0];
  if(!file)return;
  filename=file.name.replace(/\.[^.]+$/,"");
  const reader=new FileReader();
  reader.onload=e=>{
    raw=e.target.result.replace(/^\uFEFF/,"");
    output.textContent="ƒê√£ ƒë·ªçc file. Nh·∫•n 'Gi·∫£i m√£' ƒë·ªÉ b·∫Øt ƒë·∫ßu.";
    bar.style.width="20%";
    decodeBtn.disabled=false;
    downloadBtn.disabled=true;
  };
  reader.readAsText(file);
};

decodeBtn.onclick=()=>{
  if(!raw)return;
  decodeBtn.disabled=true;
  output.textContent="ƒêang gi·∫£i m√£ trong n·ªÅn...";
  bar.style.width="30%";
  if(worker)worker.terminate();
  worker=new Worker(URL.createObjectURL(new Blob([`
    function decodeChunk(chunk){
      const t=document.createElement("textarea");
      t.innerHTML=chunk;
      return t.value;
    }
    onmessage=e=>{
      const text=e.data;
      const total=text.length;
      const step=200000;
      let result="",index=0;
      function loop(){
        const part=text.slice(index,index+step);
        result+=decodeChunk(part);
        index+=step;
        postMessage({type:"progress",value:index/total});
        if(index<total)setTimeout(loop,1);
        else{
          let prev="",cur=result,loopCount=0;
          while(cur!==prev && loopCount<5){
            prev=cur;cur=decodeChunk(cur);loopCount++;
          }
          postMessage({type:"done",data:cur});
        }
      }
      loop();
    };
  `],{type:"text/javascript"})));

  worker.onmessage=e=>{
    if(e.data.type==="progress"){
      bar.style.width=(30+e.data.value*70)+"%";
    }else if(e.data.type==="done"){
      decoded=e.data.data;
      output.textContent=decoded||"(tr·ªëng)";
      bar.style.width="100%";
      downloadBtn.disabled=false;
      worker.terminate();
    }
  };

  worker.postMessage(raw);
};

downloadBtn.onclick=()=>{
  if(!decoded)return;
  const blob=new Blob([decoded],{type:"text/plain;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename+".decoded.txt";
  a.click();
  URL.revokeObjectURL(a.href);
};
</script>
</body>
</html>
